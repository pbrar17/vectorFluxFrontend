<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Statistical Solver</title>
  <!-- External libraries -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjs@11.11.0/lib/browser/math.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  
  <style>
    /* General body style */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #fdfdfd;
      color: #333;
    }
    /* Header styling */
    header {
      background-color: #0077cc;
      color: white;
      padding: 20px 40px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h1 {
      margin: 0;
      font-size: 2em;
    }
    /* Navigation styling */
    nav {
      margin-top: 10px;
      background: #eee;
      padding: 10px;
      border-radius: 5px;
    }
    nav a {
      margin-right: 15px;
      color: #0077cc;
      text-decoration: none;
      font-weight: bold;
    }
    nav a:hover {
      text-decoration: underline;
    }
    /* Main container */
    main {
      padding: 40px;
      max-width: 900px;
      margin: auto;
    }
    /* Form styling */
    form {
      background-color: #fff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 119, 204, 0.1);
      margin-bottom: 30px;
    }
    label {
      font-weight: bold;
    }
    input[type="text"],
    input[type="file"],
    select {
      width: 100%;
      padding: 10px;
      margin: 5px 0 15px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    /* Buttons */
    button {
      padding: 10px 20px;
      background-color: #0077cc;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 1em;
      cursor: pointer;
      margin-right: 10px;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #005fa3;
    }
    /* Plot container */
    #plot {
      width: 100%;
      height: 500px;
      margin-top: 30px;
    }
    /* Output message box */
    #output {
      background: #f0f9ff;
      padding: 15px;
      border-left: 4px solid #0077cc;
      border-radius: 8px;
      margin-top: 20px;
      font-size: 1.1em;
    }
    /* Stats panel styling */
    #stats-panel {
      margin-top: 20px;
      background-color: #fefefe;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 0 5px rgba(0,0,0,0.05);
      display: none;
    }
    #stats-panel h3 {
      margin-top: 0;
      color: #0077cc;
    }
    #stats-panel table {
      width: 100%;
      border-collapse: collapse;
    }
    #stats-panel th,
    #stats-panel td {
      text-align: left;
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }
    #stats-panel th {
      background-color: #f3f3f3;
    }
  </style>
</head>

<body>
  <header>
    <h1>Statistical Solver</h1>
    <nav>
      <!-- <a href="index.html">Derivative Calculator</a> -->
      <a href="3dplot.html">3D Plotter</a>
      <a href="vectorfield3dplotter.html">Vector Field Plotter</a>
      <a href="statisticalsolver.html">Statistical Solver</a>
      <a href="index.html" class="active">VecPlot</a>
    </nav>
  </header>

  <main>
    <form id="regression-form">
      <label for="x-values">X values (comma-separated):</label>
      <input type="text" id="x-values" required />

      <label for="y-values">Y values (comma-separated):</label>
      <input type="text" id="y-values" required />

      <label for="csv-upload">Or upload CSV file (with any two numeric columns):</label>
      <input type="file" id="csv-upload" accept=".csv" />

      <label for="plot-type">Select Plot Type:</label>
      <select id="plot-type">
        <option value="linear-regression">Linear Regression (Scatter + Line)</option>
        <option value="line">Line Plot</option>
        <option value="bar">Bar Chart</option>
        <option value="histogram">Histogram (Y values)</option>
      </select>

      <label for="plot-title">Custom Plot Title:</label>
      <input type="text" id="plot-title" placeholder="Enter chart title..." />

      <button type="submit">Run Analysis</button>
      <button type="button" onclick="downloadPlot()">Download Plot</button>
    </form>

    <div id="output"></div>
    <div id="stats-panel"></div>
    <div id="plot"></div>
  </main>

  <script>
    // Labels and data storage
    let xLabel = 'X';
    let yLabel = 'Y';
    let currentPlotType = 'linear-regression';
    let lastX = [];
    let lastY = [];

    // Handle form submission
    document.getElementById("regression-form").addEventListener("submit", (e) => {
      e.preventDefault();

      // Reset labels
      xLabel = 'X';
      yLabel = 'Y';

      currentPlotType = document.getElementById("plot-type").value;

      // Parse inputs
      const xStr = document.getElementById("x-values").value;
      const yStr = document.getElementById("y-values").value;

      try {
        const x = xStr.split(",").map(s => parseFloat(s.trim()));
        const y = yStr.split(",").map(s => parseFloat(s.trim()));

        // Call plotting functions based on selected type
        switch (currentPlotType) {
          case 'histogram': runHistogram(y); break;
          case 'linear-regression': runRegression(x, y); break;
          case 'line': runLinePlot(x, y); break;
          case 'bar': runBarChart(x, y); break;
          default: throw new Error("Unknown plot type");
        }

        lastX = x;
        lastY = y;
      } catch (err) {
        showOutput("Error processing input: " + err.message);
      }
    });

    // Handle CSV upload and parsing
    document.getElementById("csv-upload").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      Papa.parse(file, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: function(results) {
          const data = results.data;
          if (data.length === 0) {
            showOutput("CSV file is empty.");
            return;
          }

          const firstRow = data[0];
          if (!firstRow || Object.keys(firstRow).length < 2) {
            showOutput("CSV must contain at least two numeric columns.");
            return;
          }

          const columnNames = Object.keys(firstRow).map(name => name.trim());
          const col1 = columnNames[0];
          const col2 = columnNames[1];
          xLabel = col1;
          yLabel = col2;

          const x = data.map(row => row[col1]);
          const y = data.map(row => row[col2]);

          if (x.some(v => typeof v !== 'number' || isNaN(v)) ||
              y.some(v => typeof v !== 'number' || isNaN(v))) {
            showOutput("Selected columns must contain numeric values.");
            return;
          }

          currentPlotType = document.getElementById("plot-type").value;

          // Call plotting functions based on selected type
          switch (currentPlotType) {
            case 'histogram': runHistogram(y); break;
            case 'linear-regression': runRegression(x, y); break;
            case 'line': runLinePlot(x, y); break;
            case 'bar': runBarChart(x, y); break;
            default: showOutput("Unknown plot type selected."); return;
          }

          lastX = x;
          lastY = y;
        }
      });
    });

    // Display message in #output box
    function showOutput(msg) {
      const outputDiv = document.getElementById("output");
      outputDiv.textContent = msg;
    }

    // Clear the stats panel
    function clearStatsPanel() {
      const panel = document.getElementById("stats-panel");
      panel.style.display = "none";
      panel.innerHTML = "";
    }

    // Show stats panel with given HTML content
    function showStatsPanel(html) {
      const panel = document.getElementById("stats-panel");
      panel.style.display = "block";
      panel.innerHTML = html;
    }

    // Run linear regression and plot scatter + best fit line
    function runRegression(x, y) {
      clearStatsPanel();
      if (x.length !== y.length) {
        showOutput("X and Y must have the same number of values.");
        return;
      }
      if (x.length < 2) {
        showOutput("Need at least two data points for regression.");
        return;
      }

      // Compute means
      const meanX = math.mean(x);
      const meanY = math.mean(y);

      // Calculate slope (m) and intercept (b)
      let numerator = 0, denominator = 0;
      for (let i = 0; i < x.length; i++) {
        numerator += (x[i] - meanX) * (y[i] - meanY);
        denominator += (x[i] - meanX) ** 2;
      }
      if (denominator === 0) {
        showOutput("Cannot compute regression: all X values are identical.");
        return;
      }
      const m = numerator / denominator;
      const b = meanY - m * meanX;

      // Compute R squared
      let ssTot = 0, ssRes = 0;
      for (let i = 0; i < y.length; i++) {
        const yPred = m * x[i] + b;
        ssRes += (y[i] - yPred) ** 2;
        ssTot += (y[i] - meanY) ** 2;
      }
      const r2 = 1 - (ssRes / ssTot);

      // Prepare regression line points
      const xLine = [Math.min(...x), Math.max(...x)];
      const yLine = xLine.map(xv => m * xv + b);

      // Prepare plot title
      let plotTitle = document.getElementById("plot-title").value.trim();
      if (!plotTitle) plotTitle = "Linear Regression: " + yLabel + " vs " + xLabel;

      // Plot with Plotly
      const data = [
        {
          x, y,
          mode: 'markers',
          type: 'scatter',
          name: 'Data Points',
          marker: { color: '#0077cc' }
        },
        {
          x: xLine,
          y: yLine,
          mode: 'lines',
          type: 'scatter',
          name: `Best Fit Line (y = ${m.toFixed(3)}x + ${b.toFixed(3)})`,
          line: { color: '#ff6600', width: 3 }
        }
      ];

      const layout = {
        title: plotTitle,
        xaxis: { title: xLabel },
        yaxis: { title: yLabel },
        margin: { t: 50, b: 50 }
      };

      Plotly.newPlot('plot', data, layout, {responsive: true});
      showOutput("");

      // Display stats panel
      showStatsPanel(`
        <h3>Regression Statistics</h3>
        <table>
          <tr><th>Slope (m)</th><td>${m.toFixed(5)}</td></tr>
          <tr><th>Intercept (b)</th><td>${b.toFixed(5)}</td></tr>
          <tr><th>R² (Coefficient of Determination)</th><td>${r2.toFixed(5)}</td></tr>
          <tr><th>Data Points</th><td>${x.length}</td></tr>
        </table>
      `);
    }

    // Run simple line plot (x,y)
    function runLinePlot(x, y) {
      clearStatsPanel();
      if (x.length !== y.length) {
        showOutput("X and Y must have the same number of values.");
        return;
      }

      let plotTitle = document.getElementById("plot-title").value.trim();
      if (!plotTitle) plotTitle = "Line Plot: " + yLabel + " vs " + xLabel;

      const data = [{
        x, y,
        mode: 'lines+markers',
        type: 'scatter',
        line: { color: '#0077cc' },
        marker: { size: 6 }
      }];

      const layout = {
        title: plotTitle,
        xaxis: { title: xLabel },
        yaxis: { title: yLabel },
        margin: { t: 50, b: 50 }
      };

      Plotly.newPlot('plot', data, layout, {responsive: true});
      showOutput("");
    }

    // Run bar chart (x categories and y values)
    function runBarChart(x, y) {
      clearStatsPanel();
      if (x.length !== y.length) {
        showOutput("X and Y must have the same number of values.");
        return;
      }

      // For bar charts, x can be categories or numbers; convert all to strings
      const xLabels = x.map(v => String(v));

      let plotTitle = document.getElementById("plot-title").value.trim();
      if (!plotTitle) plotTitle = "Bar Chart: " + yLabel + " vs " + xLabel;

      const data = [{
        x: xLabels,
        y,
        type: 'bar',
        marker: { color: '#0077cc' }
      }];

      const layout = {
        title: plotTitle,
        xaxis: { title: xLabel },
        yaxis: { title: yLabel },
        margin: { t: 50, b: 50 }
      };

      Plotly.newPlot('plot', data, layout, {responsive: true});
      showOutput("");
    }

    // Run histogram for Y values
    function runHistogram(y) {
      clearStatsPanel();

      let plotTitle = document.getElementById("plot-title").value.trim();
      if (!plotTitle) plotTitle = "Histogram of " + yLabel;

      const data = [{
        x: y,
        type: 'histogram',
        marker: { color: '#0077cc' }
      }];

      const layout = {
        title: plotTitle,
        xaxis: { title: yLabel },
        yaxis: { title: 'Frequency' },
        margin: { t: 50, b: 50 }
      };

      Plotly.newPlot('plot', data, layout, {responsive: true});
      showOutput("");
    }

    // Download currently displayed plot as PNG
    function downloadPlot() {
      Plotly.downloadImage('plot', {format: 'png', filename: 'statistical_plot'});
    }
  </script>
</body>
</html>
